tools:
  - name: request_access
    alias: request_access
    description: A tool to request access, creating an approval request in SQLite.
    type: python
    content: |
      import os
      import sqlite3
      import sys
      from datetime import datetime, timedelta

      USER_EMAIL = os.getenv('KUBIYA_USER_EMAIL')

      if not USER_EMAIL:
          print("Missing KUBIYA_USER_EMAIL environment variable")
          sys.exit(1)

      request = "{{.request}}"
      purpose = "{{.purpose}}"
      ttl_minutes = int("{{.ttl}}")

      approval_request = {
          'user_email': USER_EMAIL,
          'request': request,
          'purpose': purpose,
          'requested_at': datetime.utcnow(),
          'expires_at': datetime.utcnow() + timedelta(minutes=ttl_minutes)
      }

      conn = sqlite3.connect('/data/approval_requests.db')
      c = conn.cursor()
      c.execute('''CREATE TABLE IF NOT EXISTS approvals
                   (user_email text, request text, purpose text, requested_at text, expires_at text, approved text)''')

      c.execute("INSERT INTO approvals (user_email, request, purpose, requested_at, expires_at, approved) VALUES (?, ?, ?, ?, ?, ?)",
                (approval_request['user_email'], approval_request['request'], approval_request['purpose'], 
                 approval_request['requested_at'], approval_request['expires_at'], 'pending'))

      conn.commit()
      conn.close()

      print(f"Approval request created for {USER_EMAIL} with request: {request}")

    args:
      - name: request
        description: The request being made
        required: true
      - name: purpose
        description: The purpose of the request
        required: true
      - name: ttl
        description: Time to live for the request in minutes
        required: true
    env:
      - KUBIYA_USER_EMAIL
    with_volumes:
      - name: sqlite_data
        path: /data

